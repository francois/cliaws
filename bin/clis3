#!/usr/bin/env ruby
#
#  Created on 2008-4-12.
#  Copyright (c) 2008. All rights reserved.

begin
  require 'rubygems'
rescue LoadError
  # no rubygems to load, so we fail silently
end

require "main"

$:.unshift File.dirname(__FILE__) + "/../lib"
require "cliaws"

Main {
  mixin :s3_object do
    argument("s3_object") do
      required
      argument_required
    end
  end

  mode("url") do
    mixin :s3_object

    def run
      puts Cliaws.s3.url(params["s3_object"].value)
    end
  end

  mode("list") do
    mixin :s3_object

    def run
      puts Cliaws.s3.list(params["s3_object"].value)
    end
  end

  mode("touch") do
    mixin :s3_object

    def run
      Cliaws.s3.put("", params["s3_object"].value)
    end
  end

  mode("put") do
    argument("local_files") do
      optional
      argument_required
      arity -2
    end

    option("data") do
      optional
      argument_required
    end

    def run
      if params["local_files"].given? && params["data"].given? then
        abort "Cannot give both the --data and local_files parameters at the same time"
      elsif !params["local_files"].given? && !params["data"].given? then
        source = STDIN
      elsif params["local_files"].given? && params["local_files"].values.length == 2 then
        source = File.open(params["local_files"].values.shift, "rb")
      elsif params["local_files"].given? then
        s3_object = params["local_files"].values.pop
        targets = params["local_files"].values.map {|filename| filename.to_s}
        targets.each do |local_file|
          File.open(local_file, "rb") do |source|
            remote_file = File.join(s3_object, File.basename(local_file))
            puts "%-30s => %s" % [local_file, remote_file]
            Cliaws.s3.put(source, remote_file)
          end
        end

        exit 0
      else
        source = params["data"].value
      end

      Cliaws.s3.put(source, params["local_files"].values.pop)
    end
  end

  mode("rm") do
    mixin :s3_object

    def run
      Cliaws.s3.rm(params["s3_object"].value)
    end
  end

  mode("cat") do
    mixin :s3_object

    def run
      Cliaws.s3.get(params["s3_object"].value, STDOUT)
      puts
    end
  end

  mode("get") do
    mixin :s3_object

    argument("local_file") do
      argument_required
      optional
    end

    def run
      if params["local_file"].given? then
        dest = File.open(params["local_file"].value, "wb")
      else
        dest = STDOUT
      end

      Cliaws.s3.get(params["s3_object"].value, dest)
    end
  end

  mode("head") do
    mixin :s3_object

    def run
      Cliaws.s3.head(params["s3_object"].value)
    end
  end

  def run
    abort "Required action argument missing.  Run '#{$0} help' for details."
  end
}
